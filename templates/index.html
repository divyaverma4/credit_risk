<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Card Risk Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    .tab-content { display: none; transition: opacity 0.3s ease; }
    .tab-content.active { display: block; opacity: 1; pointer-events: auto; }
    .tab-content:not(.active) { opacity: 0; pointer-events: none; }
  </style>
</head>
<body class="bg-gray-100 p-6 font-sans h-full">

<h1 class="text-3xl font-bold text-center mb-6 text-blue-700">Card Risk Report</h1>

<!-- Tabs -->
<div class="max-w-6xl mx-auto mb-4">
  <div class="flex border-b border-gray-300">
    <button onclick="openTab('individual', event)" class="tab-btn px-4 py-2 font-semibold text-blue-700 border-b-2 border-blue-700" data-tab="individual">Individual Cardholders</button>
    <button onclick="openTab('company', event)" class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-700" data-tab="company">Company Cardholders</button>
    <button onclick="openTab('ml', event)" class="tab-btn px-4 py-2 font-semibold text-gray-600 hover:text-blue-700" data-tab="ml">ML: Using CRR to predict Credit Limit</button>
  </div>
</div>

<div class="max-w-6xl mx-auto h-[calc(100vh-160px)] space-y-4">

  <!-- Individual Tab -->
  <div id="individual" class="tab-content active">
    <div class="bg-white rounded-2xl shadow p-5 flex flex-col h-full">
      <h2 class="text-xl font-semibold mb-4">Individual Cardholders</h2>

      <!-- Pie Chart -->
      <div class="w-full flex justify-center items-center mb-4">
        <canvas id="indPie" class="w-full h-64 max-w-xs"></canvas>
      </div>

      <!-- Table -->
      <div class="flex-1 overflow-auto border p-2">
        {% if full_individuals %}
        <div class="flex justify-between items-center mb-2">
          <span class="font-semibold text-gray-700">Sort by:</span>
          <select onchange="sortTable(this, 'indTable')" class="border rounded px-2 py-1">
            {% for col in full_individuals[0].keys() %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>

        <table id="indTable" class="min-w-full border border-gray-300">
          <thead class="bg-gray-200">
            <tr>
              {% for col in full_individuals[0].keys() %}
              <th class="border px-2 py-1">{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in full_individuals %}
            <tr>
              {% for col, value in row.items() %}
              <td class="border px-2 py-1 {% if col=='RiskCategory' %}font-bold {% if value=='High Risk' %}text-red-600{% elif value=='Medium Risk' %}text-yellow-600{% else %}text-green-600{% endif %}{% endif %}">
                {{ value or 'N/A' }}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-gray-500">No individual records found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Company Tab -->
  <div id="company" class="tab-content">
    <div class="bg-white rounded-2xl shadow p-5 flex flex-col h-full">
      <h2 class="text-xl font-semibold mb-4">Company Cardholders</h2>

      <!-- Pie Chart -->
      <div class="w-full flex justify-center items-center mb-4">
        <canvas id="compPie" class="w-full h-64 max-w-xs"></canvas>
      </div>

      <!-- Table -->
      <div class="flex-1 overflow-auto border p-2">
        {% if full_companies %}
        <div class="flex justify-between items-center mb-2">
          <span class="font-semibold text-gray-700">Sort by:</span>
          <select onchange="sortTable(this, 'compTable')" class="border rounded px-2 py-1">
            {% for col in full_companies[0].keys() %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>

        <table id="compTable" class="min-w-full border border-gray-300">
          <thead class="bg-gray-200">
            <tr>
              {% for col in full_companies[0].keys() %}
              <th class="border px-2 py-1">{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in full_companies %}
            <tr>
              {% for col, value in row.items() %}
              <td class="border px-2 py-1 {% if col=='RiskCategory' %}font-bold {% if value=='High Risk' %}text-red-600{% elif value=='Medium Risk' %}text-yellow-600{% else %}text-green-600{% endif %}{% endif %}">
                {{ value or 'N/A' }}
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-gray-500">No company records found.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ML Tab -->
<div id="ml" class="tab-content">
  <div class="bg-white rounded-2xl shadow p-5 flex flex-col h-full">
    <h2 class="text-xl font-semibold mb-4">TO-DO: Predicted Credit Limits</h2>

    <!-- Predicted Credit Limits Table -->
    <div class="flex-1 overflow-auto border p-2 mb-6">
      <table class="min-w-full border border-gray-300">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">ID</th>
            <th class="border px-2 py-1">Predicted Credit Limit</th>
          </tr>
        </thead>
        <tbody>
          {% if predictions %}
            {% for pred in predictions %}
              <tr>
                <td class="border px-2 py-1">{{ pred.customer_id }}</td>
                <td class="border px-2 py-1">${{ pred.credit_limit }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td class="border px-2 py-1 text-gray-500" colspan="2">No predictions available.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Feature Importance Section -->
    <h2 class="text-xl font-semibold mb-4">TO-DO: Feature Importance</h2>
    <div class="flex flex-1 space-x-4">
      <div class="flex-1 flex flex-col">
        <div class="flex-1 overflow-auto border p-2">
          <table class="min-w-full border border-gray-300">
            <thead class="bg-gray-200">
              <tr>
                <th class="border px-2 py-1">Feature</th>
                <th class="border px-2 py-1">Importance</th>
              </tr>
            </thead>
            <tbody>
              <tr><td class="border px-2 py-1">Income</td><td class="border px-2 py-1">0.35</td></tr>
              <tr><td class="border px-2 py-1">Credit Utilization</td><td class="border px-2 py-1">0.25</td></tr>
              <tr><td class="border px-2 py-1">Payment History</td><td class="border px-2 py-1">0.20</td></tr>
              <tr><td class="border px-2 py-1">Age</td><td class="border px-2 py-1">0.10</td></tr>
              <tr><td class="border px-2 py-1">Employment Length</td><td class="border px-2 py-1">0.10</td></tr>
            </tbody>
          </table>
        </div>
        <div class="w-1/3 flex justify-center items-center mt-4">
          <canvas id="featurePie" class="w-full h-64 max-w-xs"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Scripts -->
<script>
function openTab(tabId, event) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('text-blue-700', 'border-blue-700');
    btn.classList.add('text-gray-600');
  });

  event.currentTarget.classList.remove('text-gray-600');
  event.currentTarget.classList.add('text-blue-700', 'border-blue-700');
}

function sortTable(select, tableId) {
  const table = document.getElementById(tableId);
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  const colName = select.value;
  const headers = Array.from(table.tHead.rows[0].cells);
  const colIndex = headers.findIndex(th => th.textContent.trim() === colName.trim());

  rows.sort((a, b) => {
    let valA = a.cells[colIndex].textContent.trim();
    let valB = b.cells[colIndex].textContent.trim();

    // Convert risk levels to sortable numbers
    if (colName === 'RiskCategory') {
      const map = {'High Risk': 3, 'Medium Risk': 2, 'Low Risk': 1};
      valA = map[valA] || 0;
      valB = map[valB] || 0;
    } else {
      const numA = parseFloat(valA);
      const numB = parseFloat(valB);
      if (!isNaN(numA) && !isNaN(numB)) { valA = numA; valB = numB; }
    }

    return valA > valB ? 1 : valA < valB ? -1 : 0;
  });

  rows.forEach(row => tbody.appendChild(row));
}

// Pie Charts
const indData = {
  labels: ['High Risk','Medium Risk','Low Risk'],
  datasets: [{ data: {{ ind_counts|safe }}, backgroundColor: ['#ef4444','#facc15','#22c55e'] }]
};
new Chart(document.getElementById('indPie'), { type: 'pie', data: indData, options: { responsive:true, maintainAspectRatio:false } });

const compData = {
  labels: ['High Risk','Medium Risk','Low Risk'],
  datasets: [{ data: {{ comp_counts|safe }}, backgroundColor: ['#ef4444','#facc15','#22c55e'] }]
};
new Chart(document.getElementById('compPie'), { type: 'pie', data: compData, options: { responsive:true, maintainAspectRatio:false } });

const featureData = {
  labels: ['Income','Credit Utilization','Payment History','Age','Employment Length'],
  datasets: [{ data: [0.35, 0.25, 0.20, 0.10, 0.10], backgroundColor: ['#3b82f6','#f97316','#14b8a6','#eab308','#8b5cf6'] }]
};
new Chart(document.getElementById('featurePie'), { type: 'pie', data: featureData, options: { responsive:true, maintainAspectRatio:false } });

</script>

</body>
</html>
